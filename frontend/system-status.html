<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Status - Prompt Machine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="js/config.js"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <!-- System Status Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- API Status -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-900">API Status</h3>
                    <div id="api-status-badge" class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full">
                        Loading...
                    </div>
                </div>
                <div id="api-details" class="text-sm text-gray-600">
                    <div class="space-y-1">
                        <div>Status: <span class="font-medium">Checking...</span></div>
                        <div>Uptime: <span class="font-medium">--</span></div>
                        <div>Version: <span class="font-medium">--</span></div>
                    </div>
                </div>
            </div>

            <!-- Database Status -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-900">Database</h3>
                    <div id="database-status-badge" class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full">
                        Loading...
                    </div>
                </div>
                <div id="database-details" class="text-sm text-gray-600">
                    <div class="space-y-1">
                        <div>Connection: <span class="font-medium">Checking...</span></div>
                        <div>Pool Size: <span class="font-medium">--</span></div>
                        <div>Active Connections: <span class="font-medium">--</span></div>
                    </div>
                </div>
            </div>

            <!-- AI Service Status -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-900">AI Service</h3>
                    <div id="ai-status-badge" class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full">
                        Loading...
                    </div>
                </div>
                <div id="ai-details" class="text-sm text-gray-600">
                    <div class="space-y-1">
                        <div>Provider: <span class="font-medium">--</span></div>
                        <div>Model: <span class="font-medium">--</span></div>
                        <div>Status: <span class="font-medium">Checking...</span></div>
                    </div>
                </div>
            </div>

            <!-- Storage Status -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-gray-900">Storage</h3>
                    <div id="storage-status-badge" class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full">
                        Loading...
                    </div>
                </div>
                <div id="storage-details" class="text-sm text-gray-600">
                    <div class="space-y-1">
                        <div>Disk Usage: <span class="font-medium">--</span></div>
                        <div>Available: <span class="font-medium">--</span></div>
                        <div>Database Size: <span class="font-medium">--</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed System Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">Detailed System Information</h3>
                    <button onclick="refreshStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-refresh mr-2"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="detailed-status" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Detailed information will be loaded here -->
                    <div class="text-center text-gray-500 py-8 col-span-2">
                        <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                        <p>Loading detailed system information...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load system status
        async function loadSystemStatus() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/admin/system/status/public', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    displaySystemStatus(data.status);
                } else {
                    displaySystemError(data.error || 'Failed to load system status');
                }
            } catch (error) {
                console.error('Error loading system status:', error);
                displaySystemError('Network error loading system status');
            }
        }
        
        // Display system status
        function displaySystemStatus(status) {
            // API Status
            const apiStatusBadge = document.getElementById('api-status-badge');
            const apiDetails = document.getElementById('api-details');
            
            if (status.api.healthy) {
                apiStatusBadge.className = 'px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                apiStatusBadge.textContent = 'Healthy';
                apiDetails.innerHTML = `
                    <div class="space-y-1">
                        <div>Status: <span class="font-medium text-green-600">Online</span></div>
                        <div>Uptime: <span class="font-medium">${status.api.uptime}</span></div>
                        <div>Version: <span class="font-medium">${status.api.version}</span></div>
                    </div>
                `;
            } else {
                apiStatusBadge.className = 'px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                apiStatusBadge.textContent = 'Error';
                apiDetails.innerHTML = `
                    <div class="space-y-1">
                        <div>Status: <span class="font-medium text-red-600">Offline</span></div>
                        <div>Error: <span class="font-medium">${status.api.error || 'Unknown'}</span></div>
                    </div>
                `;
            }

            // Database Status
            const databaseStatusBadge = document.getElementById('database-status-badge');
            const databaseDetails = document.getElementById('database-details');
            
            if (status.database.connected) {
                databaseStatusBadge.className = 'px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                databaseStatusBadge.textContent = 'Connected';
                databaseDetails.innerHTML = `
                    <div class="space-y-1">
                        <div>Connection: <span class="font-medium text-green-600">Active</span></div>
                        <div>Pool Size: <span class="font-medium">${status.database.pool_size}</span></div>
                        <div>Active Connections: <span class="font-medium">${status.database.active_connections}</span></div>
                    </div>
                `;
            } else {
                databaseStatusBadge.className = 'px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                databaseStatusBadge.textContent = 'Disconnected';
                databaseDetails.innerHTML = `
                    <div class="space-y-1">
                        <div>Connection: <span class="font-medium text-red-600">Failed</span></div>
                        <div>Error: <span class="font-medium">${status.database.error || 'Unknown'}</span></div>
                    </div>
                `;
            }

            // AI Service Status
            const aiStatusBadge = document.getElementById('ai-status-badge');
            const aiDetails = document.getElementById('ai-details');
            
            if (status.ai_service.configured) {
                aiStatusBadge.className = 'px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                aiStatusBadge.textContent = 'Active';
                aiDetails.innerHTML = `
                    <div class="space-y-1">
                        <div>Provider: <span class="font-medium">${status.ai_service.provider}</span></div>
                        <div>Model: <span class="font-medium">${status.ai_service.model}</span></div>
                        <div>Status: <span class="font-medium text-green-600">Ready</span></div>
                    </div>
                `;
            } else {
                aiStatusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
                aiStatusBadge.textContent = 'Not Configured';
                aiDetails.innerHTML = `
                    <div class="space-y-1">
                        <div>Provider: <span class="font-medium">--</span></div>
                        <div>Model: <span class="font-medium">--</span></div>
                        <div>Status: <span class="font-medium text-yellow-600">Needs Configuration</span></div>
                    </div>
                `;
            }

            // Storage Status
            const storageStatusBadge = document.getElementById('storage-status-badge');
            const storageDetails = document.getElementById('storage-details');
            
            const usagePercent = parseFloat(status.storage.root_disk.usage_percentage);
            if (usagePercent < 80) {
                storageStatusBadge.className = 'px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                storageStatusBadge.textContent = 'Good';
            } else if (usagePercent < 90) {
                storageStatusBadge.className = 'px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
                storageStatusBadge.textContent = 'Warning';
            } else {
                storageStatusBadge.className = 'px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                storageStatusBadge.textContent = 'Critical';
            }
            
            storageDetails.innerHTML = `
                <div class="space-y-1">
                    <div>Disk Usage: <span class="font-medium">${status.storage.root_disk.usage_percentage}</span></div>
                    <div>Available: <span class="font-medium">${status.storage.root_disk.available_size}</span></div>
                    <div>Database Size: <span class="font-medium">${status.storage.database_size}</span></div>
                </div>
            `;

            // Detailed Status
            const detailedStatus = document.getElementById('detailed-status');
            detailedStatus.innerHTML = `
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Server Information</h4>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div><span class="font-medium">Hostname:</span> ${status.system.hostname}</div>
                        <div><span class="font-medium">Platform:</span> ${status.system.platform}</div>
                        <div><span class="font-medium">Architecture:</span> ${status.system.arch}</div>
                        <div><span class="font-medium">Node Version:</span> ${status.system.node_version}</div>
                        <div><span class="font-medium">Memory Usage:</span> ${status.system.memory_usage}</div>
                        <div><span class="font-medium">CPU Usage:</span> ${status.system.cpu_usage}</div>
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-900 mb-3">Storage Details</h4>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div><span class="font-medium">Filesystem:</span> ${status.storage.root_disk.filesystem}</div>
                        <div><span class="font-medium">Total Size:</span> ${status.storage.root_disk.total_size}</div>
                        <div><span class="font-medium">Used:</span> ${status.storage.root_disk.used_size}</div>
                        <div><span class="font-medium">Available:</span> ${status.storage.root_disk.available_size}</div>
                        <div><span class="font-medium">Mount Point:</span> ${status.storage.root_disk.mount_point}</div>
                        <div><span class="font-medium">Database Size:</span> ${status.storage.database_size}</div>
                    </div>
                </div>
            `;
        }

        // Display error
        function displaySystemError(error) {
            // Set all status badges to error
            ['api-status-badge', 'database-status-badge', 'ai-status-badge', 'storage-status-badge'].forEach(id => {
                const badge = document.getElementById(id);
                badge.className = 'px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                badge.textContent = 'Error';
            });

            // Show error message
            document.getElementById('detailed-status').innerHTML = `
                <div class="text-center text-red-600 py-8 col-span-2">
                    <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
                    <p class="font-medium">System Status Error</p>
                    <p class="text-sm mt-2">${error}</p>
                </div>
            `;
        }

        // Refresh status
        function refreshStatus() {
            loadSystemStatus();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            
            // Auto refresh every 30 seconds
            setInterval(loadSystemStatus, 30000);
        });
    </script>
</body>
</html>