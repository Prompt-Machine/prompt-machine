<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tool Wizard v3 - Prompt Machine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/config.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b-2 border-purple-200">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        üßô‚Äç‚ôÇÔ∏è AI Tool Wizard v3
                    </h1>
                    <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        Production Ready
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='advertising-settings.html'" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-medium">
                        üí∞ Monetize Tools
                    </button>
                    <button onclick="window.location.href='/'" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        ‚Üê Dashboard
                    </button>
                    <span id="userEmail" class="text-gray-600"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-16">
            <div class="text-purple-600 text-6xl mb-4 animate-pulse">üßô‚Äç‚ôÇÔ∏è</div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Loading Wizard...</h2>
            <p class="text-gray-600">Preparing the tool creation experience</p>
        </div>

        <!-- Main Wizard Interface -->
        <div id="wizardInterface" class="hidden max-w-6xl mx-auto">
            <!-- Wizard Progress Bar -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Tool Creation Progress</h2>
                <div class="flex items-center space-x-4">
                    <!-- Step 1 -->
                    <div id="step1Indicator" class="flex items-center space-x-2">
                        <div id="step1Circle" class="w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center font-semibold text-sm">
                            1
                        </div>
                        <span id="step1Text" class="font-medium text-purple-600">Concept</span>
                    </div>
                    
                    <div id="progress12" class="flex-1 h-1 bg-gray-300 rounded"></div>
                    
                    <!-- Step 2 -->
                    <div id="step2Indicator" class="flex items-center space-x-2">
                        <div id="step2Circle" class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm">
                            2
                        </div>
                        <span id="step2Text" class="font-medium text-gray-500">Build</span>
                    </div>
                    
                    <div id="progress23" class="flex-1 h-1 bg-gray-300 rounded"></div>
                    
                    <!-- Step 3 -->
                    <div id="step3Indicator" class="flex items-center space-x-2">
                        <div id="step3Circle" class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm">
                            3
                        </div>
                        <span id="step3Text" class="font-medium text-gray-500">Deploy</span>
                    </div>
                </div>
            </div>

            <!-- Step Content Area -->
            <div class="bg-white rounded-lg shadow-lg">
                <!-- STEP 1: CONCEPT CONVERSATION -->
                <div id="step1Content" class="p-8">
                    <div class="text-center mb-8">
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">üí¨ Describe Your AI Tool</h3>
                        <p class="text-gray-600 max-w-2xl mx-auto">
                            Have a conversation with Claude to define your tool concept. 
                            Describe what you want your tool to do, and Claude will help you refine the idea.
                        </p>
                    </div>

                    <!-- Tool Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tool Name</label>
                            <input 
                                type="text" 
                                id="toolName" 
                                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg"
                                placeholder="My Amazing AI Tool"
                                maxlength="100"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                            <input 
                                type="text" 
                                id="toolDescription" 
                                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                placeholder="Brief description of what your tool does"
                                maxlength="200"
                            >
                        </div>
                    </div>

                    <!-- Conversation Area -->
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg p-6 mb-6">
                        <div id="conversationArea" class="bg-white rounded-lg p-6 h-80 overflow-y-auto mb-4 shadow-inner">
                            <div id="conversationEmpty" class="text-center py-16 text-gray-500">
                                <div class="text-4xl mb-4">ü§ñ</div>
                                <h4 class="text-lg font-semibold mb-2">Ready to brainstorm?</h4>
                                <p>Start by describing what you want your AI tool to do. I'll help you refine the concept and suggest the perfect features!</p>
                            </div>
                            <div id="conversationMessages"></div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <input 
                                type="text" 
                                id="conversationInput" 
                                class="flex-1 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                placeholder="Describe your tool idea..."
                                maxlength="500"
                            >
                            <button 
                                id="sendMessageBtn" 
                                onclick="sendConversationMessage()" 
                                class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-4 rounded-lg hover:from-purple-600 hover:to-blue-600 font-semibold shadow-lg"
                            >
                                Send
                            </button>
                        </div>
                    </div>

                    <!-- Step 1 Navigation -->
                    <div class="flex justify-end">
                        <button 
                            id="step1NextBtn" 
                            onclick="goToStep(2)" 
                            class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg hover:from-purple-600 hover:to-blue-600 font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Continue to Build ‚Üí
                        </button>
                    </div>
                </div>

                <!-- STEP 2: FIELD BUILDING -->
                <div id="step2Content" class="p-8 hidden">
                    <div class="text-center mb-8">
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">üîß Build Your Tool</h3>
                        <p class="text-gray-600 max-w-2xl mx-auto">
                            Configure the input fields for your tool. Edit the fields suggested by Claude or add your own.
                        </p>
                    </div>

                    <!-- Subdomain Configuration -->
                    <div class="bg-blue-50 rounded-lg p-6 mb-8">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">üåê Tool URL</h4>
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-600">https://</span>
                            <input 
                                type="text" 
                                id="toolSubdomain" 
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                placeholder="my-tool"
                                pattern="[a-zA-Z0-9\-]+"
                                maxlength="50"
                            >
                            <span class="text-gray-600">.tool.prompt-machine.com</span>
                            <div id="subdomainStatus" class="ml-4 text-sm"></div>
                        </div>
                    </div>

                    <!-- Fields Management -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-lg font-semibold text-gray-800">‚öôÔ∏è Input Fields</h4>
                            <button 
                                onclick="addField()" 
                                class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold"
                            >
                                + Add Field
                            </button>
                        </div>

                        <div id="fieldsContainer" class="space-y-4">
                            <div id="fieldsEmpty" class="text-center py-16 text-gray-500">
                                <div class="text-4xl mb-4">üìù</div>
                                <h4 class="text-lg font-semibold mb-2">No fields yet</h4>
                                <p>Add fields for users to interact with your tool, or go back to Step 1 to get suggestions from Claude.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 Navigation -->
                    <div class="flex justify-between">
                        <button 
                            onclick="goToStep(1)" 
                            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold"
                        >
                            ‚Üê Back to Concept
                        </button>
                        <button 
                            id="step2NextBtn" 
                            onclick="goToStep(3)" 
                            class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg hover:from-purple-600 hover:to-blue-600 font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Continue to Deploy ‚Üí
                        </button>
                    </div>
                </div>

                <!-- STEP 3: DEPLOYMENT -->
                <div id="step3Content" class="p-8 hidden">
                    <div class="text-center mb-8">
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">üöÄ Deploy Your Tool</h3>
                        <p class="text-gray-600 max-w-2xl mx-auto">
                            Review your tool configuration and deploy it live to the internet.
                        </p>
                    </div>

                    <!-- Tool Review -->
                    <div class="space-y-6 mb-8">
                        <!-- Tool Summary -->
                        <div class="bg-purple-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-purple-800 mb-4">üìã Tool Summary</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <span class="font-medium text-gray-700">Name:</span>
                                    <span id="reviewToolName" class="ml-2 text-gray-900">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">URL:</span>
                                    <span id="reviewToolUrl" class="ml-2 text-blue-600">-</span>
                                </div>
                                <div class="md:col-span-2">
                                    <span class="font-medium text-gray-700">Description:</span>
                                    <span id="reviewToolDescription" class="ml-2 text-gray-900">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Fields Review -->
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-blue-800 mb-4">üìù Input Fields</h4>
                            <div id="reviewFields" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- Deployment Status -->
                    <div id="deploymentStatus" class="mb-8 hidden">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="text-yellow-600 text-xl mr-3">üöÄ</div>
                                <div>
                                    <h4 class="font-semibold text-yellow-800">Deployment in Progress</h4>
                                    <p class="text-yellow-700 text-sm">Creating your tool files and making it live...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 Navigation -->
                    <div class="flex justify-between">
                        <button 
                            onclick="goToStep(2)" 
                            class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold"
                        >
                            ‚Üê Back to Build
                        </button>
                        <div class="space-x-4">
                            <button 
                                id="saveToolBtn" 
                                onclick="saveTool()" 
                                class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold"
                            >
                                üíæ Save Tool
                            </button>
                            <button 
                                id="deployToolBtn" 
                                onclick="deployTool()" 
                                class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-3 rounded-lg hover:from-green-600 hover:to-blue-600 font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                üåü Deploy Live
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessages" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
    </div>

    <script>
        // =====================================
        // AI TOOL WIZARD V3 - PRODUCTION READY
        // =====================================

        // State Management
        let currentTool = null;
        let currentStep = 1;
        let toolFields = [];
        let conversation = [];
        let isEditingMode = false;
        let fieldCounter = 1;

        // Initialize Wizard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üßô‚Äç‚ôÇÔ∏è Initializing Tool Wizard v3...');
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                window.location.href = '/';
                return;
            }

            try {
                // Get user info
                const userResponse = await PMConfig.fetch('api/auth/me');
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    document.getElementById('userEmail').textContent = userData.user.email;
                } else {
                    throw new Error('Authentication failed');
                }

                // Check if editing existing tool
                const urlParams = new URLSearchParams(window.location.search);
                const toolId = urlParams.get('id');
                
                if (toolId) {
                    // Editing mode
                    isEditingMode = true;
                    await loadExistingTool(toolId);
                } else {
                    // New tool mode
                    await initializeNewTool();
                }

                // Setup event listeners
                setupEventListeners();

                // Show interface
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('wizardInterface').classList.remove('hidden');

                console.log('‚úÖ Wizard initialized successfully');

            } catch (error) {
                console.error('Wizard initialization error:', error);
                showStatus('Failed to initialize wizard', 'red');
                setTimeout(() => window.location.href = '/', 3000);
            }
        });

        // Setup Event Listeners
        function setupEventListeners() {
            // Tool name and description changes
            document.getElementById('toolName').addEventListener('input', handleBasicInfoChange);
            document.getElementById('toolDescription').addEventListener('input', handleBasicInfoChange);
            
            // Subdomain changes
            document.getElementById('toolSubdomain').addEventListener('input', handleSubdomainChange);
            
            // Enter key in conversation
            document.getElementById('conversationInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendConversationMessage();
                }
            });
        }

        // Initialize New Tool
        async function initializeNewTool() {
            try {
                const response = await PMConfig.fetch('api/v3/tools', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: 'New AI Tool',
                        description: ''
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentTool = data.tool;
                    
                    // Update URL
                    const newUrl = `${window.location.pathname}?id=${currentTool.id}`;
                    window.history.replaceState({}, '', newUrl);
                    
                    // Set initial values
                    document.getElementById('toolName').value = currentTool.name;
                    document.getElementById('toolDescription').value = currentTool.description || '';
                    
                    currentStep = 1;
                    updateWizardProgress();
                    
                    console.log('‚úÖ New tool created:', currentTool.id);
                    
                } else {
                    throw new Error('Failed to create new tool');
                }
            } catch (error) {
                console.error('New tool error:', error);
                throw error;
            }
        }

        // Load Existing Tool
        async function loadExistingTool(toolId) {
            try {
                const response = await PMConfig.fetch(`api/v3/tools/${toolId}`);

                if (response.ok) {
                    const data = await response.json();
                    currentTool = data.tool;
                    
                    // Load tool data
                    document.getElementById('toolName').value = currentTool.name;
                    document.getElementById('toolDescription').value = currentTool.description || '';
                    document.getElementById('toolSubdomain').value = currentTool.subdomain || '';
                    
                    // Load conversation
                    conversation = currentTool.concept_conversation || [];
                    if (conversation.length > 0) {
                        displayConversation();
                    }
                    
                    // Load fields
                    toolFields = currentTool.fields || [];
                    if (toolFields.length > 0) {
                        renderFields();
                        fieldCounter = Math.max(...toolFields.map(f => f.id || 0)) + 1;
                    }
                    
                    // Set current step
                    currentStep = currentTool.wizard_step || 1;
                    updateWizardProgress();
                    goToStep(currentStep);
                    
                    console.log('‚úÖ Tool loaded:', currentTool.name, 'Step:', currentStep);
                    
                } else {
                    throw new Error('Tool not found');
                }
            } catch (error) {
                console.error('Load tool error:', error);
                throw error;
            }
        }

        // Handle Basic Info Changes
        function handleBasicInfoChange() {
            // Auto-save basic info changes
            const name = document.getElementById('toolName').value.trim();
            const description = document.getElementById('toolDescription').value.trim();
            
            if (name !== currentTool.name || description !== (currentTool.description || '')) {
                currentTool.name = name;
                currentTool.description = description;
                updateStep1Progress();
                
                // Debounced save
                clearTimeout(window.basicInfoSaveTimeout);
                window.basicInfoSaveTimeout = setTimeout(saveBasicInfo, 1000);
            }
        }

        // Save Basic Info
        async function saveBasicInfo() {
            if (!currentTool.id) return;
            
            try {
                await PMConfig.fetch(`api/v3/tools/${currentTool.id}/step/1`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: currentTool.name,
                        description: currentTool.description,
                        conversation: conversation
                    })
                });
            } catch (error) {
                console.error('Save basic info error:', error);
            }
        }

        // Send Conversation Message
        async function sendConversationMessage() {
            const input = document.getElementById('conversationInput');
            const message = input.value.trim();
            
            if (!message || !currentTool.id) return;
            
            const sendBtn = document.getElementById('sendMessageBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';
            
            try {
                input.value = '';
                
                const response = await PMConfig.fetch(`api/v3/tools/${currentTool.id}/chat`, {
                    method: 'POST',
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    conversation = data.conversation;
                    
                    // Display updated conversation
                    displayConversation();
                    
                    // Handle suggested fields
                    if (data.suggestedFields && data.suggestedFields.length > 0) {
                        handleSuggestedFields(data.suggestedFields);
                        showStatus(`‚ú® Claude suggested ${data.suggestedFields.length} fields!`, 'green');
                    }
                    
                    // Update system prompt if provided
                    if (data.systemPrompt) {
                        currentTool.system_prompt = data.systemPrompt;
                    }
                    
                    updateStep1Progress();
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to send message');
                }
                
            } catch (error) {
                console.error('Send message error:', error);
                showStatus(`Error: ${error.message}`, 'red');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        // Display Conversation
        function displayConversation() {
            const container = document.getElementById('conversationMessages');
            const emptyState = document.getElementById('conversationEmpty');
            
            if (conversation.length === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            
            container.innerHTML = conversation.map(msg => `
                <div class="mb-4 ${msg.role === 'user' ? 'text-right' : 'text-left'}">
                    <div class="inline-block max-w-sm lg:max-w-md px-4 py-3 rounded-lg ${
                        msg.role === 'user' 
                            ? 'bg-purple-500 text-white' 
                            : 'bg-gray-100 text-gray-800 border'
                    }">
                        <div class="text-sm whitespace-pre-wrap">${msg.content}</div>
                    </div>
                </div>
            `).join('');
            
            // Scroll to bottom
            setTimeout(() => {
                const area = document.getElementById('conversationArea');
                area.scrollTop = area.scrollHeight;
            }, 100);
        }

        // Handle Suggested Fields
        function handleSuggestedFields(suggestedFields) {
            const existingNames = toolFields.map(f => f.name.toLowerCase());
            
            suggestedFields.forEach(field => {
                if (!existingNames.includes(field.name.toLowerCase())) {
                    const newField = {
                        id: fieldCounter++,
                        name: field.name || 'New Field',
                        type: field.type || 'text',
                        placeholder: field.placeholder || 'Enter value...',
                        required: field.required !== false,
                        options: field.options || []
                    };
                    toolFields.push(newField);
                }
            });
            
            renderFields();
            updateStep2Progress();
        }

        // Add Field Manually
        function addField() {
            const field = {
                id: fieldCounter++,
                name: `Field ${toolFields.length + 1}`,
                type: 'text',
                placeholder: 'Enter value...',
                required: true,
                options: []
            };
            
            toolFields.push(field);
            renderFields();
            updateStep2Progress();
        }

        // Render Fields
        function renderFields() {
            const container = document.getElementById('fieldsContainer');
            const emptyState = document.getElementById('fieldsEmpty');
            
            // Add null checks to prevent errors
            if (!container) {
                console.error('fieldsContainer element not found');
                return;
            }
            
            if (toolFields.length === 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                container.innerHTML = '';
                return;
            }
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            container.innerHTML = toolFields.map((field, index) => `
                <div class="border-2 border-gray-200 rounded-lg p-4 bg-gray-50">
                    <div class="flex items-center justify-between mb-4">
                        <input 
                            type="text" 
                            value="${field.name || 'New Field'}" 
                            onchange="updateField(${index}, 'name', this.value)"
                            class="font-semibold text-lg bg-white border border-gray-300 rounded px-3 py-2 flex-1 mr-4 focus:ring-2 focus:ring-purple-500"
                            placeholder="Field Name"
                        >
                        <button 
                            onclick="removeField(${index})"
                            class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600"
                        >
                            Remove
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select 
                                onchange="updateField(${index}, 'type', this.value)"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-purple-500"
                            >
                                <option value="text" ${field.type === 'text' ? 'selected' : ''}>Text</option>
                                <option value="textarea" ${field.type === 'textarea' ? 'selected' : ''}>Textarea</option>
                                <option value="dropdown" ${field.type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                                <option value="number" ${field.type === 'number' ? 'selected' : ''}>Number</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    ${field.required ? 'checked' : ''}
                                    onchange="updateField(${index}, 'required', this.checked)"
                                    class="mr-2"
                                >
                                <span class="text-sm font-medium text-gray-700">Required</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Placeholder</label>
                        <input 
                            type="text" 
                            value="${field.placeholder || 'Enter value...'}" 
                            onchange="updateField(${index}, 'placeholder', this.value)"
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-purple-500"
                            placeholder="Placeholder text"
                        >
                    </div>
                    
                    ${field.type === 'dropdown' ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Options (one per line)</label>
                        <textarea 
                            onchange="updateFieldOptions(${index}, this.value)"
                            class="w-full border border-gray-300 rounded px-3 py-2 h-20 focus:ring-2 focus:ring-purple-500"
                            placeholder="Option 1&#10;Option 2&#10;Option 3"
                        >${(field.options || []).join('\\n')}</textarea>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Update Field
        function updateField(index, property, value) {
            toolFields[index][property] = value;
            if (property === 'type') renderFields(); // Re-render for dropdown options
            updateStep2Progress();
            saveFieldsDebounced();
        }

        // Update Field Options
        function updateFieldOptions(index, optionsText) {
            toolFields[index].options = optionsText.split('\\n').filter(opt => opt.trim());
            updateStep2Progress();
            saveFieldsDebounced();
        }

        // Remove Field
        function removeField(index) {
            if (confirm('Remove this field?')) {
                toolFields.splice(index, 1);
                renderFields();
                updateStep2Progress();
                saveFieldsDebounced();
            }
        }

        // Handle Subdomain Changes
        function handleSubdomainChange() {
            const subdomain = document.getElementById('toolSubdomain').value.trim().toLowerCase();
            const statusDiv = document.getElementById('subdomainStatus');
            
            // Clean subdomain
            const cleanSubdomain = subdomain.replace(/[^a-zA-Z0-9-]/g, '');
            if (cleanSubdomain !== subdomain) {
                document.getElementById('toolSubdomain').value = cleanSubdomain;
                return;
            }
            
            if (cleanSubdomain.length < 3) {
                statusDiv.innerHTML = '<span class="text-orange-600">‚ö†Ô∏è At least 3 characters</span>';
            } else {
                statusDiv.innerHTML = '<span class="text-green-600">‚úì Valid</span>';
                // TODO: Add real-time availability check
            }
            
            updateStep2Progress();
            saveFieldsDebounced();
        }

        // Debounced save for fields
        function saveFieldsDebounced() {
            clearTimeout(window.fieldsSaveTimeout);
            window.fieldsSaveTimeout = setTimeout(saveStep2Data, 1000);
        }

        // Save Step 2 Data
        async function saveStep2Data() {
            if (!currentTool.id) return;
            
            try {
                const subdomain = document.getElementById('toolSubdomain').value.trim().toLowerCase();
                
                await PMConfig.fetch(`api/v3/tools/${currentTool.id}/step/2`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        fields: toolFields,
                        subdomain: subdomain || null
                    })
                });
                
                currentTool.subdomain = subdomain;
                
            } catch (error) {
                console.error('Save step 2 error:', error);
                showStatus('Failed to save changes', 'red');
            }
        }

        // Navigation Functions
        function goToStep(step) {
            // Hide all step contents
            document.getElementById('step1Content').classList.add('hidden');
            document.getElementById('step2Content').classList.add('hidden');
            document.getElementById('step3Content').classList.add('hidden');
            
            // Show target step
            document.getElementById(`step${step}Content`).classList.remove('hidden');
            
            currentStep = step;
            updateWizardProgress();
            
            // Update step-specific data
            if (step === 3) {
                updateDeploymentReview();
            }
        }

        // Update Wizard Progress
        function updateWizardProgress() {
            // Reset all indicators
            [1, 2, 3].forEach(step => {
                const circle = document.getElementById(`step${step}Circle`);
                const text = document.getElementById(`step${step}Text`);
                
                if (step < currentStep) {
                    // Completed step
                    circle.className = 'w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-semibold text-sm';
                    circle.innerHTML = '‚úì';
                    text.className = 'font-medium text-green-600';
                } else if (step === currentStep) {
                    // Current step
                    circle.className = 'w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center font-semibold text-sm';
                    circle.innerHTML = step;
                    text.className = 'font-medium text-purple-600';
                } else {
                    // Future step
                    circle.className = 'w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm';
                    circle.innerHTML = step;
                    text.className = 'font-medium text-gray-500';
                }
            });
            
            // Update progress bars
            const progress12 = document.getElementById('progress12');
            const progress23 = document.getElementById('progress23');
            
            progress12.className = `flex-1 h-1 rounded ${currentStep > 1 ? 'bg-green-500' : 'bg-gray-300'}`;
            progress23.className = `flex-1 h-1 rounded ${currentStep > 2 ? 'bg-green-500' : 'bg-gray-300'}`;
        }

        // Update Step Progress
        function updateStep1Progress() {
            const hasName = document.getElementById('toolName').value.trim().length > 0;
            const hasConversation = conversation.length > 0;
            
            const nextBtn = document.getElementById('step1NextBtn');
            nextBtn.disabled = !hasName;
        }

        function updateStep2Progress() {
            const hasSubdomain = document.getElementById('toolSubdomain').value.trim().length >= 3;
            const hasFields = toolFields.length > 0;
            
            const nextBtn = document.getElementById('step2NextBtn');
            nextBtn.disabled = !(hasSubdomain && hasFields);
        }

        // Update Deployment Review
        function updateDeploymentReview() {
            const name = document.getElementById('toolName').value.trim();
            const description = document.getElementById('toolDescription').value.trim();
            const subdomain = document.getElementById('toolSubdomain').value.trim();
            
            document.getElementById('reviewToolName').textContent = name || 'Untitled Tool';
            document.getElementById('reviewToolDescription').textContent = description || 'No description';
            document.getElementById('reviewToolUrl').textContent = subdomain ? `https://${subdomain}.tool.prompt-machine.com` : 'No URL set';
            
            const reviewFields = document.getElementById('reviewFields');
            if (toolFields.length === 0) {
                reviewFields.innerHTML = '<p class="text-gray-500">No fields configured</p>';
            } else {
                reviewFields.innerHTML = toolFields.map(field => `
                    <div class="flex items-center justify-between py-1 px-2 bg-white rounded">
                        <span class="font-medium">${field.name}</span>
                        <span class="text-sm text-gray-500">${field.type}${field.required ? ' *' : ''}</span>
                    </div>
                `).join('');
            }
            
            // Update deploy button state
            const canDeploy = name && subdomain && toolFields.length > 0;
            document.getElementById('deployToolBtn').disabled = !canDeploy;
        }

        // Save Tool
        async function saveTool() {
            const saveBtn = document.getElementById('saveToolBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'üíæ Saving...';
            
            try {
                await saveStep2Data(); // Ensure latest data is saved
                showStatus('‚úÖ Tool saved successfully!', 'green');
                
                saveBtn.textContent = '‚úÖ Saved';
                setTimeout(() => {
                    saveBtn.textContent = 'üíæ Save Tool';
                    saveBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Save tool error:', error);
                showStatus('‚ùå Failed to save tool', 'red');
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Save Tool';
            }
        }

        // Deploy Tool
        async function deployTool() {
            if (!currentTool.id) return;
            
            const deployBtn = document.getElementById('deployToolBtn');
            const statusDiv = document.getElementById('deploymentStatus');
            
            deployBtn.disabled = true;
            deployBtn.textContent = 'üöÄ Deploying...';
            statusDiv.classList.remove('hidden');
            
            try {
                const response = await PMConfig.fetch(`api/v3/tools/${currentTool.id}/deploy`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    statusDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <div class="text-green-600 text-xl mr-3">üéâ</div>
                                <div>
                                    <h4 class="font-semibold text-green-800">Deployment Successful!</h4>
                                    <p class="text-green-700 text-sm">Your tool is now live at: 
                                        <a href="${data.url}" target="_blank" class="font-semibold underline">${data.url}</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    deployBtn.textContent = 'üåü Deployed';
                    deployBtn.className = 'bg-green-500 text-white px-8 py-3 rounded-lg font-semibold shadow-lg';
                    
                    showStatus('üéâ Tool deployed successfully!', 'green');
                    
                    // Offer to open the tool
                    setTimeout(() => {
                        if (confirm('Tool deployed successfully! Would you like to open it in a new tab?')) {
                            window.open(data.url, '_blank');
                        }
                    }, 2000);
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Deployment failed');
                }
                
            } catch (error) {
                console.error('Deploy error:', error);
                showStatus(`‚ùå Deployment failed: ${error.message}`, 'red');
                
                statusDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="text-red-600 text-xl mr-3">‚ùå</div>
                            <div>
                                <h4 class="font-semibold text-red-800">Deployment Failed</h4>
                                <p class="text-red-700 text-sm">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                deployBtn.disabled = false;
                deployBtn.textContent = 'üåü Deploy Live';
            }
        }

        // Show Status Message
        function showStatus(message, type) {
            const container = document.getElementById('statusMessages');
            const statusDiv = document.createElement('div');
            
            const colorMap = {
                green: 'bg-green-100 border-green-500 text-green-700',
                red: 'bg-red-100 border-red-500 text-red-700',
                blue: 'bg-blue-100 border-blue-500 text-blue-700',
                yellow: 'bg-yellow-100 border-yellow-500 text-yellow-700'
            };
            
            statusDiv.className = `${colorMap[type]} border-l-4 p-4 rounded shadow-lg max-w-md mb-2`;
            statusDiv.innerHTML = message;
            
            container.appendChild(statusDiv);
            
            // Auto-remove after 6 seconds
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, 6000);
        }

        // Initialize progress tracking
        document.addEventListener('DOMContentLoaded', () => {
            // Set up initial progress tracking
            setTimeout(() => {
                if (document.getElementById('toolName')) {
                    updateStep1Progress();
                    updateStep2Progress();
                }
            }, 1000);
        });
    </script>
</body>
</html>